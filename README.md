# 七边形 2025 年秋季招新题目！

嗨，欢迎来做七边形的招新题！

招新题是一个C++ 小项目，使用 Make 构建捏。你需要对这个项目做你能想到的性能优化，使其在保持正确性的前提下，跑得尽可能快喵。

* 我们将会提供七边形的机器供大家在上面编程和调试捏。最终加速比（也就是性能表现）将会以在七边形机器上测试的结果为准喵。
* 集群使用 [spack](https://spack.io/) 进行包管理，你可以通过spack找到一些你想要的包喵。
* 默认的机器（即登录节点）仅有一台，且没有 GPU捏。集群通过 [slurm](https://slurm.schedmd.com/documentation.html) 进行管理，我们提供了一份示例脚本，请通过slurm提交运行作业，禁止在登录节点上运行喵。
* 队内集群中数个节点包含GPU捏。如果你编写了很酷的多机并行算法，或者编写了很酷的 GPU 加速模块，可以使用 slurm 运行你的应用程序，我们允许使用整个集群的资源喵。
* 如果遇到无法解决的问题，可以联系管理员获取相关支持喵。

请仔细阅读下面的规则、题目详情和提交方式喵。

截止时间为 **2025年10月15号**捏。你需要要那之前完成并提交所有工作喵。


## 题目大意

稀疏矩阵（sparse matrix），在数值分析中，是其元素大部分为零的矩阵捏。反之，如果大部分元素都非零，则这个矩阵是稠密(dense)的捏。在科学与工程学领域中求解线性模型时经常出现大型的稀疏矩阵喵。

在使用计算机存储和操作稀疏矩阵时，经常需要修改标准算法以利用矩阵的稀疏结构捏。由于其自身的稀疏特性，通过压缩可以大大节省稀疏矩阵的内存代价捏。更为重要的是，由于过大的尺寸，标准的算法经常无法操作这些稀疏矩阵喵。

在数学上，广义最小残量方法(一般简称GMRES)是一个求解线性方程组 数值解的迭代方法，由Yousef Saad和Martin H. Schultz在1986年提出捏。这个方法利用在Krylov子空间中有着最小残量的向量来逼近解捏。Arnoldi迭代方法被用来求解这个向量喵。

本次招新的笔试任务是对**稀疏矩阵GMRES**进行优化，我们会给出80个矩阵及对应的80个向量，矩阵采用CSR格式存储，你需要在残差验证不超过 $`10^{-6}`$ 的条件下使运行时间尽可能缩短，我们会提供一个基准时间(见gmres_baseline.txt)，分数计算公式为：
$$\sum_{r_i \leq 10^{-6}}{(1-\dfrac{T_i}{T_{baseline,i}})^2\times 1.25}$$
我们会实时公布你的分数，并每三天记录一次，最终成绩中$`30\%`$为5个checkpoint分数的平均值，$`70\%`$为最终提交的成绩喵。

作为考察的一部分，我们不会提供关于登录集群的帮助，请自行探索`toolchain`喵。

你需要在**2025年9月29日 22:00**前提交一份`baseline`以确保你有能力使用集群，否则计0分喵。

## 实现要求

项目目录如下：

```
.
├── gmres_baseline.txt*
├── inc
│   ├── gmres.hpp*
│   └── sparseMatrix.hpp*
├── Makefile
├── README.md
├── src
│   ├── gmres.cpp
│   └── main.cpp*
└── test.slurm
```

* 程序运行后会产生一个`gmres_time.txt`文件，包含每行一个矩阵序号、迭代次数、运行时间和残差喵。
* 所需的矩阵文件存储在集群上，具体路径在`test.slurm`中有标注，禁止更改这些文件喵。
* 在**不更改计算逻辑**（即算法大框架不能改变）且**结果正确**（输出文件格式正确且残差符合要求）的情况下，可以任意修改**不带星号的**项目源文件及构建文件喵。
* 最终主要需要更改的应该是`src/gmres.cpp`喵。
* 目录下还包含一个格式文件`.clang-format`，为保持良好编码风格，建议使用[clang-format](https://clang.llvm.org/docs/ClangFormat.html)格式化代码，也可以使用`make format`自动格式化所有源代码喵。


### 注意
* 本题目主要考察对该算法的优化，故**禁止**调用任何第三方线性代数库喵。
* **禁止**根据输入数据的某些特征对程序进行针对性优化，例如打表等喵。
* **禁止**更改标注为不可更改的地方的值喵。
* 本题不考虑迭代算法预处理器/预条件子的优化（如Jacobi预处理器、块对角预处理器、ILU预处理器等），故**禁止**使用任何预处理器/预条件喵。
* 考虑到冷启动问题，本题允许选手在计时之前添加warmup代码，但该代码不得改变GMRES的输入喵。


## 编译、运行和测试

通过
```
make
```
构建项目喵。

通过
```
sbatch test.slurm
```
提交作业喵。

这会在当前目录生成一个`.out`和`.err`文件分别表示程序的标准输出和错误输出，同时生成一个`gmres_time.txt`，每行一个矩阵编号、时间和残差喵。


最终评测时，我们会通过相同的流程运行你的程序，请确保你的程序可以通过该流程且能产生正确格式的`gmres_time.txt`喵。



## 提交与测评

你需要 fork 题目仓库，并在代码提交截止日期前将自己的仓库链接以 issue 的方式发表在本仓库下。你的仓库应该包含优化实现的代码喵。

请注意做题过程中将仓库设为`private`，在截止时间后再设为`public`喵。

同时，在做题过程中，你需要将仓库放在家目录下，确保`~/recruitment-2025-autumn/gmres_time.txt`文件存在，以确保我们可以知道性能分数喵。

与此同时，你需要制作一份 ppt，内容如下喵：

* 每一步优化的思路、过程和效果（举例：使用了 xxx 优化，相对于原代码，速度提升了 114.514 倍）
* 最好对程序进行 profile，以了解性能瓶颈
* 你在解题过程中所参考的资料（如有使用人工智能工具，请注明）
* 在解题过程中，遇到的有意思的事情，或者是让你印象深刻的 bug（可选）

代码审查会用到这份 ppt，因此请你按照邮件给出的连接提交喵。

另外，在笔试结束后（具体时间另外通知），你需要准备一次展示，向我们介绍你的优化成果喵。

如果对题目本身或者提交方式有任何问题，请积极在群里讨论喵。

### 注意

- 我们的分数通过读取`gmres_time.txt`中记载的最后一次运行数据给出,榜单会实时更新，每个checkpoint(每隔两天的凌晨4:00)，请确保该文件存在、最后一次运行完整、可读取，否则该checkpoint分数为0喵。
- `gmres_time.txt`中记录的数据禁止造假，我们会根据你的ppt中记录的进度判断数据是否合理，同时请在版本控制中保留每天最终的代码以供查证（通过`commit`或者`tag`等方式）喵。
- 出于策略考虑，你可以选择不提供`gmres_time.txt`或者提供一份较老的数据，但必须确保其真实性喵。

## 提示

* 良好的版本控制习惯可以有效避免 “改了一下午代码后它跑不起来了，但是我又改不回去了” 之类的极端情况喵。推荐使用 [Git](https://git-scm.com/)
* 使用 htop/glances 或者资源管理器查看 CPU 负载是验证自己程序正在并行工作的好方法之一喵。
* Perf 是 Linux 下常用的性能分析工具喵：<https://www.brendangregg.com/perf.html>
* 火焰图可以直观地展示程序的性能热点喵：<https://www.brendangregg.com/flamegraphs.html>
* OpenMP 是常用的并行计算框架喵：<https://bisqwit.iki.fi/story/howto/openmp/>
* 如果需要做多机的并行，你可能会对 MPI 感兴趣喵：<https://mpitutorial.com/tutorials/>
* SIMD 是提升程序单核性能的有效手段喵：<https://zhuanlan.zhihu.com/p/583326378> <https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#>
* 适量的 Cache 知识不仅对单核优化有用，也能避免一些多线程场景下的诡异问题喵：<https://zhuanlan.zhihu.com/p/136300660>
* 更加系统性的高性能计算知识，请参考七边形的 HPC 学习路线喵：<https://heptagonhust.github.io/HPC-roadmap/>
* Slurm 怎么用喵: <http://scc.ustc.edu.cn/zlsc/user_doc/html/slurm/index.html>
* 什么是 GMRES 算法喵: <https://en.wikipedia.org/wiki/Generalized_minimal_residual_method>


以及一些技术无关的提示：

* 如果遇到问题，请积极在 QQ 群内提问喵。
* 部分优化可能相当难做/难调。所以即使没有写出程序/调试成功，也欢迎把自己的天才优化想法写进提交的文档里，通过文字来展示自己对高性能计算的理解和认知喵。
